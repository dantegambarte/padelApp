<section class="admin-panel">
  <mat-card class="mat-elevation-z2">
    <header class="card-header">
      <div>
        <h3>Políticas y recordatorios</h3>
        <p>Actualizá la seña, el mensaje visible para los usuarios y la automatización de avisos.</p>
      </div>
    </header>
    <form class="admin-form" [formGroup]="facade.policyForm">
      <mat-form-field appearance="outline">
        <mat-label>Porcentaje de seña</mat-label>
        <input matInput type="number" formControlName="depositPercentage" min="0" max="100" />
        <span matSuffix style="margin-right: 1rem;">%</span>
        <mat-error>Ingresá un valor entre 0 y 100</mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Mensaje visible para jugadores</mat-label>
        <textarea matInput formControlName="policyText" rows="3"></textarea>
        <mat-error>El mensaje debe tener al menos 10 caracteres</mat-error>
      </mat-form-field>
      <mat-slide-toggle formControlName="autoReminders" color="primary">
        Enviar recordatorios automáticos 24 h antes del turno
      </mat-slide-toggle>
      <button mat-flat-button color="primary" type="button" (click)="facade.updatePolicies()">
        Guardar cambios
      </button>
    </form>
  </mat-card>

  <mat-card class="mat-elevation-z2">
    <header class="card-header">
      <div>
        <h3>Bloquear turnos</h3>
        <p>Reservá espacios fijos por semana para mantenimiento, torneos o eventos especiales.</p>
      </div>
    </header>
    <form class="admin-form" [formGroup]="facade.blockForm">
      <mat-form-field appearance="outline">
        <mat-label>Cancha</mat-label>
        <mat-select formControlName="courtId">
          <mat-option *ngFor="let court of facade.courts$ | async" [value]="court.id">
            {{ court.name }}
          </mat-option>
        </mat-select>
        <mat-error>Seleccioná una cancha</mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Día de la semana</mat-label>
        <mat-select formControlName="dayOfWeek">
          <mat-option *ngFor="let day of facade.weekdayOptions" [value]="day.value">
            {{ day.label }}
          </mat-option>
        </mat-select>
        <mat-error>Elegí un día</mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Hora de inicio</mat-label>
        <mat-select formControlName="startTime">
          <ng-container *ngIf="facade.blockAvailableStartTimes$ | async as timeOptions">
            <mat-option *ngFor="let time of timeOptions" [value]="time">{{ time }}</mat-option>
            <mat-option *ngIf="!timeOptions.length" disabled>
              {{
              facade.blockForm.controls.courtId.value
              ? 'No hay horarios libres para este turno fijo'
              : 'Seleccioná una cancha para ver horarios'
              }}
            </mat-option>
          </ng-container>
        </mat-select>
        <mat-error>Indicá el horario</mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Duración</mat-label>
        <mat-select formControlName="duration">
          <mat-option *ngFor="let option of facade.durationOptions" [value]="option.value">{{ option.label
            }}</mat-option>
        </mat-select>
        <mat-error>Definí la duración</mat-error>
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Motivo</mat-label>
        <textarea matInput formControlName="reason" rows="2"
          placeholder="Mantenimiento, evento privado, etc."></textarea>
      </mat-form-field>
      <button mat-stroked-button color="primary" type="button" (click)="facade.blockSlot()">
        Bloquear turno
      </button>
    </form>
  </mat-card>

  <mat-card class="mat-elevation-z2" *ngIf="facade.adminReservations$ | async as adminReservations">
    <header class="card-header">
      <div>
        <h3>Reservas del club</h3>
        <p>Filtrá por fecha, estado o cancha para gestionar todas las reservas.</p>
      </div>
    </header>
    <p *ngIf="!adminReservations.length" class="empty-state">
      No hay reservas que coincidan con los filtros seleccionados.
    </p>
    <table mat-table *ngIf="adminReservations.length" [dataSource]="adminReservations" [trackBy]="facade.trackById"
      class="mat-elevation-z1">
      <ng-container matColumnDef="court">
        <th mat-header-cell *matHeaderCellDef>Cancha</th>
        <td mat-cell *matCellDef="let reservation">{{ reservation.courtName }}</td>
      </ng-container>
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let reservation">{{ reservation.date | date: 'dd/MM/yyyy' }}</td>
      </ng-container>
      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef>Horario</th>
        <td mat-cell *matCellDef="let reservation">
          <div class="time-cell">
            <span>{{ reservation.startTime }} - {{ reservation.endTime }}</span>
            <span class="fixed-turn-chip" *ngIf="reservation.fixedTurn">Turno fijo</span>
          </div>
        </td>
      </ng-container>
      <ng-container matColumnDef="contact">
        <th mat-header-cell *matHeaderCellDef>Contacto</th>
        <td mat-cell *matCellDef="let reservation">
          <div>{{ reservation.contactName }}</div>
          <small>{{ reservation.contactEmail }}</small>
        </td>
      </ng-container>
      <ng-container matColumnDef="deposit">
        <th mat-header-cell *matHeaderCellDef>Pagos</th>
        <td mat-cell *matCellDef="let reservation">
          <span class="deposit-chip" [ngClass]="facade.getDepositBadge(reservation)">
            Seña {{ reservation.depositPaid ? 'pagada' : 'pendiente' }}
          </span>
          <div class="total">Total: {{ reservation.totalPrice | currency: 'ARS':'symbol':'1.0-0' }}</div>
        </td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let reservation">
          <span class="status-chip" [ngClass]="facade.statusClass(reservation)">
            {{ facade.getStatusLabel(reservation.status) }}
          </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let reservation">
          <button mat-icon-button color="primary" type="button" (click)="facade.markDepositPaid(reservation)"
            matTooltip="Registrar seña">
            <mat-icon>paid</mat-icon>
          </button>
          <button mat-icon-button color="primary" type="button" (click)="facade.markCompleted(reservation)"
            matTooltip="Marcar como completada">
            <mat-icon>done_all</mat-icon>
          </button>
          <button mat-icon-button color="primary" type="button" (click)="facade.toggleReminder(reservation)"
            matTooltip="Alternar recordatorio">
            <mat-icon>{{ reservation.remindersSent ? 'notifications_off' : 'notifications_active' }}</mat-icon>
          </button>
          <button mat-icon-button color="warn" type="button" (click)="facade.cancel(reservation)" matTooltip="Cancelar">
            <mat-icon>{{ reservation.status === 'bloqueada' ? 'lock_open' : 'cancel' }}</mat-icon>
          </button>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="facade.adminColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: facade.adminColumns"></tr>
    </table>
  </mat-card>
</section>
